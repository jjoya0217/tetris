<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í…ŒíŠ¸ë¦¬ìŠ¤ ë°°í‹€ - ì˜¨ë¼ì¸ ëŒ€ì „</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="start-screen">
        <div class="title-container">
            <h1 class="game-title">ğŸ® í…ŒíŠ¸ë¦¬ìŠ¤ ë°°í‹€</h1>
            <p class="subtitle">ì¹œêµ¬ì™€ ì˜¨ë¼ì¸ ëŒ€ì „!</p>
        </div>

        <div class="login-container" id="loginContainer">
            <h2>í”Œë ˆì´ì–´ ì´ë¦„ ì…ë ¥</h2>
            <input type="text" id="playerName" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" maxlength="10">
            <button id="setNameBtn" class="btn-primary">í™•ì¸</button>
        </div>

        <div class="menu-container hidden" id="menuContainer">
            <h2>í™˜ì˜í•©ë‹ˆë‹¤, <span id="welcomeName"></span>ë‹˜!</h2>
            
            <div class="menu-section">
                <h3>ğŸ¯ ë°© ë§Œë“¤ê¸°</h3>
                <p>ìƒˆë¡œìš´ ê²Œì„ë°©ì„ ë§Œë“¤ê³  ì¹œêµ¬ë¥¼ ì´ˆëŒ€í•˜ì„¸ìš”</p>
                <button id="createRoomBtn" class="btn-primary">ë°© ë§Œë“¤ê¸°</button>
            </div>

            <div class="menu-section">
                <h3>ğŸ”— ë°© ì°¸ê°€í•˜ê¸°</h3>
                <p>ì¹œêµ¬ê°€ ê³µìœ í•œ ë°© ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”</p>
                <input type="text" id="roomCode" placeholder="ë°© ì½”ë“œ ì…ë ¥ (ì˜ˆ: ABC123)" maxlength="6">
                <button id="joinRoomBtn" class="btn-primary">ì°¸ê°€í•˜ê¸°</button>
            </div>

            <div class="menu-section">
                <h3>ğŸ“Š ìˆœìœ„í‘œ ë³´ê¸°</h3>
                <p>ì „ì²´ í”Œë ˆì´ì–´ ìˆœìœ„ë¥¼ í™•ì¸í•˜ì„¸ìš”</p>
                <button id="leaderboardBtn" class="btn-primary">ìˆœìœ„í‘œ ë³´ê¸°</button>
            </div>

            <div class="stats-section">
                <h3>ğŸ“Š ë‚´ ì „ì </h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <span class="stat-label">ì´ ê²Œì„</span>
                        <span class="stat-value" id="totalGames">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">ìŠ¹ë¦¬</span>
                        <span class="stat-value" id="wins">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">ìŠ¹ë¥ </span>
                        <span class="stat-value" id="winRate">0%</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="waiting-room hidden" id="waitingRoom">
            <h2>ëŒ€ê¸°ì‹¤</h2>
            <div class="room-info">
                <p>ë°© ì½”ë“œ: <span id="currentRoomCode" class="room-code"></span></p>
                <button id="copyCodeBtn" class="btn-secondary">ì½”ë“œ ë³µì‚¬</button>
            </div>
            <div class="players-list">
                <div class="player-slot">
                    <span class="player-icon">ğŸ‘¤</span>
                    <span id="player1Name">ëŒ€ê¸° ì¤‘...</span>
                </div>
                <div class="vs-text">VS</div>
                <div class="player-slot">
                    <span class="player-icon">ğŸ‘¤</span>
                    <span id="player2Name">ëŒ€ê¸° ì¤‘...</span>
                </div>
            </div>
            <p class="waiting-text">ì¹œêµ¬ê°€ ì°¸ê°€í•  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...</p>
            <button id="cancelRoomBtn" class="btn-danger">ì·¨ì†Œ</button>
        </div>

        <!-- ìˆœìœ„í‘œ ëª¨ë‹¬ -->
        <div class="leaderboard-modal hidden" id="leaderboardModal">
            <div class="leaderboard-content">
                <h2>ğŸ† ì „ì²´ ìˆœìœ„í‘œ</h2>
                <button class="close-modal" id="closeLeaderboard">Ã—</button>
                
                <div class="leaderboard-tabs">
                    <button class="tab-btn active" data-tab="score">ìµœê³  ì ìˆ˜</button>
                    <button class="tab-btn" data-tab="wins">ìŠ¹ë¦¬ íšŸìˆ˜</button>
                </div>

                <div class="leaderboard-list" id="scoreLeaderboard">
                    <h3>ğŸ† ìµœê³  ì ìˆ˜ ìˆœìœ„</h3>
                    <div class="loading">ìˆœìœ„í‘œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                </div>

                <div class="leaderboard-list hidden" id="winsLeaderboard">
                    <h3>ğŸ‘‘ ìŠ¹ë¦¬ íšŸìˆ˜ ìˆœìœ„</h3>
                    <div class="loading">ìˆœìœ„í‘œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <script src="js/firebase-config.js"></script>
    <script>
        // ì „ì—­ ë³€ìˆ˜
        let playerName = '';
        let playerTag = ''; // ë‹‰ë„¤ì„#ë²ˆí˜¸
        let currentRoomCode = '';
        let playerStats = { totalGames: 0, wins: 0 };

        // 4ìë¦¬ ëœë¤ ë²ˆí˜¸ ìƒì„±
        function generatePlayerTag() {
            return Math.floor(1000 + Math.random() * 9000).toString();
        }

        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ í†µê³„ ë¶ˆëŸ¬ì˜¤ê¸°
        function loadStats() {
            const saved = localStorage.getItem('tetrisStats');
            if (saved) {
                playerStats = JSON.parse(saved);
                updateStatsDisplay();
            }
        }

        // í†µê³„ í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateStatsDisplay() {
            document.getElementById('totalGames').textContent = playerStats.totalGames;
            document.getElementById('wins').textContent = playerStats.wins;
            const winRate = playerStats.totalGames > 0 
                ? Math.round((playerStats.wins / playerStats.totalGames) * 100) 
                : 0;
            document.getElementById('winRate').textContent = winRate + '%';
        }

        // ì´ë¦„ ì„¤ì •
        document.getElementById('setNameBtn').addEventListener('click', () => {
            const name = document.getElementById('playerName').value.trim();
            if (name && name.length >= 2) {
                // ê¸°ì¡´ì— ì €ì¥ëœ íƒœê·¸ê°€ ìˆëŠ”ì§€ í™•ì¸
                let savedTag = localStorage.getItem('playerTag');
                
                if (!savedTag) {
                    // ìƒˆë¡œìš´ íƒœê·¸ ìƒì„±
                    savedTag = generatePlayerTag();
                    localStorage.setItem('playerTag', savedTag);
                }
                
                playerName = name;
                playerTag = name + '#' + savedTag;
                
                localStorage.setItem('playerName', name);
                localStorage.setItem('playerFullName', playerTag);
                
                document.getElementById('welcomeName').textContent = playerTag;
                document.getElementById('loginContainer').classList.add('hidden');
                document.getElementById('menuContainer').classList.remove('hidden');
                loadStats();
            } else {
                alert('ì´ë¦„ì€ ìµœì†Œ 2ê¸€ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”!');
            }
        });

        // ë°© ë§Œë“¤ê¸°
        document.getElementById('createRoomBtn').addEventListener('click', async () => {
            currentRoomCode = generateRoomCode();
            
            try {
                await createRoom(currentRoomCode, playerTag);
                showWaitingRoom();
            } catch (error) {
                console.error('ë°© ìƒì„± ì˜¤ë¥˜:', error);
                alert('ë°© ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            }
        });

        // ë°© ì°¸ê°€í•˜ê¸°
        document.getElementById('joinRoomBtn').addEventListener('click', async () => {
            const roomCode = document.getElementById('roomCode').value.trim().toUpperCase();
            
            if (roomCode.length !== 6) {
                alert('ì˜¬ë°”ë¥¸ ë°© ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”! (6ìë¦¬)');
                return;
            }

            try {
                const success = await joinRoom(roomCode, playerTag);
                if (success) {
                    currentRoomCode = roomCode;
                    // ê²Œì„ ì‹œì‘
                    startGame(roomCode, playerTag, false);
                } else {
                    alert('ë°©ì„ ì°¾ì„ ìˆ˜ ì—†ê±°ë‚˜ ì´ë¯¸ ê²Œì„ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('ë°© ì°¸ê°€ ì˜¤ë¥˜:', error);
                alert('ë°© ì°¸ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            }
        });

        // ìˆœìœ„í‘œ ë³´ê¸° ë²„íŠ¼
        document.getElementById('leaderboardBtn').addEventListener('click', () => {
            document.getElementById('leaderboardModal').classList.remove('hidden');
            loadLeaderboard('score');
        });

        // ìˆœìœ„í‘œ ë‹«ê¸°
        document.getElementById('closeLeaderboard').addEventListener('click', () => {
            document.getElementById('leaderboardModal').classList.add('hidden');
        });

        // ìˆœìœ„í‘œ íƒ­ ì „í™˜
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tab = btn.dataset.tab;
                
                // íƒ­ í™œì„±í™”
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                // ìˆœìœ„í‘œ í‘œì‹œ
                document.getElementById('scoreLeaderboard').classList.add('hidden');
                document.getElementById('winsLeaderboard').classList.add('hidden');
                
                if (tab === 'score') {
                    document.getElementById('scoreLeaderboard').classList.remove('hidden');
                    loadLeaderboard('score');
                } else {
                    document.getElementById('winsLeaderboard').classList.remove('hidden');
                    loadLeaderboard('wins');
                }
            });
        });

        // ìˆœìœ„í‘œ ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadLeaderboard(type) {
            const containerId = type === 'score' ? 'scoreLeaderboard' : 'winsLeaderboard';
            const container = document.getElementById(containerId);
            
            container.innerHTML = type === 'score' 
                ? '<h3>ğŸ† ìµœê³  ì ìˆ˜ ìˆœìœ„</h3><div class="loading">ìˆœìœ„í‘œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>'
                : '<h3>ğŸ‘‘ ìŠ¹ë¦¬ íšŸìˆ˜ ìˆœìœ„</h3><div class="loading">ìˆœìœ„í‘œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
            
            try {
                const leaderboard = await fetchLeaderboard(type);
                displayLeaderboard(leaderboard, type, container);
            } catch (error) {
                console.error('ìˆœìœ„í‘œ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:', error);
                container.innerHTML += '<p class="error">ìˆœìœ„í‘œë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>';
            }
        }

        // ìˆœìœ„í‘œ í‘œì‹œ
        function displayLeaderboard(data, type, container) {
            const title = type === 'score' ? 'ğŸ† ìµœê³  ì ìˆ˜ ìˆœìœ„' : 'ğŸ‘‘ ìŠ¹ë¦¬ íšŸìˆ˜ ìˆœìœ„';
            
            if (data.length === 0) {
                container.innerHTML = `
                    <h3>${title}</h3>
                    <p class="no-data">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                `;
                return;
            }
            
            const medals = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰', '4.', '5.'];
            const myTag = localStorage.getItem('playerFullName');
            
            let html = `<h3>${title}</h3><div class="leaderboard-items">`;
            
            data.forEach((player, index) => {
                const isMe = player.displayName === myTag;
                const medal = medals[index] || (index + 1) + '.';
                
                if (type === 'score') {
                    html += `
                        <div class="leaderboard-item ${isMe ? 'highlight' : ''}">
                            <span class="rank">${medal}</span>
                            <span class="player-name">${player.displayName}</span>
                            <span class="score">${player.bestScore.toLocaleString()}ì </span>
                        </div>
                    `;
                } else {
                    html += `
                        <div class="leaderboard-item ${isMe ? 'highlight' : ''}">
                            <span class="rank">${medal}</span>
                            <span class="player-name">${player.displayName}</span>
                            <span class="score">${player.totalWins}ìŠ¹ (${player.winRate}%)</span>
                        </div>
                    `;
                }
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        // ë°© ì·¨ì†Œ
        document.getElementById('cancelRoomBtn').addEventListener('click', async () => {
            if (currentRoomCode) {
                await cancelRoom(currentRoomCode);
                hideWaitingRoom();
            }
        });

        // ì½”ë“œ ë³µì‚¬
        document.getElementById('copyCodeBtn').addEventListener('click', () => {
            navigator.clipboard.writeText(currentRoomCode).then(() => {
                alert('ë°© ì½”ë“œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
            });
        });

        // ëŒ€ê¸°ì‹¤ í‘œì‹œ
        function showWaitingRoom() {
            document.getElementById('menuContainer').classList.add('hidden');
            document.getElementById('waitingRoom').classList.remove('hidden');
            document.getElementById('currentRoomCode').textContent = currentRoomCode;
            document.getElementById('player1Name').textContent = playerTag;
            document.getElementById('player2Name').textContent = 'ëŒ€ê¸° ì¤‘...';
        }

        // ëŒ€ê¸°ì‹¤ ìˆ¨ê¸°ê¸°
        function hideWaitingRoom() {
            document.getElementById('waitingRoom').classList.add('hidden');
            document.getElementById('menuContainer').classList.remove('hidden');
            currentRoomCode = '';
        }

        // ë°© ì½”ë“œ ìƒì„± (6ìë¦¬ ì˜ë¬¸+ìˆ«ì)
        function generateRoomCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        // ê²Œì„ ì‹œì‘
        function startGame(roomCode, playerName, isHost) {
            localStorage.setItem('gameRoom', roomCode);
            localStorage.setItem('playerName', playerName);
            localStorage.setItem('isHost', isHost);
            window.location.href = 'game.html';
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì €ì¥ëœ ì´ë¦„ ë¶ˆëŸ¬ì˜¤ê¸°
        window.addEventListener('load', () => {
            const savedName = localStorage.getItem('playerName');
            const savedTag = localStorage.getItem('playerTag');
            
            if (savedName) {
                document.getElementById('playerName').value = savedName;
            }
            
            // íƒœê·¸ê°€ ì—†ìœ¼ë©´ ìë™ ìƒì„±
            if (!savedTag) {
                const newTag = generatePlayerTag();
                localStorage.setItem('playerTag', newTag);
            }
        });
    </script>
</body>
</html>
