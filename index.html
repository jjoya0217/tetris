<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í…ŒíŠ¸ë¦¬ìŠ¤ ë°°í‹€ - ì˜¨ë¼ì¸ ëŒ€ì „</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="start-screen">
        <div class="title-container">
            <h1 class="game-title">ğŸ® í…ŒíŠ¸ë¦¬ìŠ¤ ë°°í‹€</h1>
            <p class="subtitle">ì¹œêµ¬ì™€ ì˜¨ë¼ì¸ ëŒ€ì „!</p>
        </div>

        <div class="login-container" id="loginContainer">
            <h2>í”Œë ˆì´ì–´ ì´ë¦„ ì…ë ¥</h2>
            <input type="text" id="playerName" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" maxlength="10">
            <button id="setNameBtn" class="btn-primary">í™•ì¸</button>
        </div>

        <div class="menu-container hidden" id="menuContainer">
            <h2>í™˜ì˜í•©ë‹ˆë‹¤, <span id="welcomeName"></span>ë‹˜!</h2>
            
            <div class="menu-section">
                <h3>ğŸ¯ ë°© ë§Œë“¤ê¸°</h3>
                <p>ìƒˆë¡œìš´ ê²Œì„ë°©ì„ ë§Œë“¤ê³  ì¹œêµ¬ë¥¼ ì´ˆëŒ€í•˜ì„¸ìš”</p>
                <button id="createRoomBtn" class="btn-primary">ë°© ë§Œë“¤ê¸°</button>
            </div>

            <div class="menu-section">
                <h3>ğŸ”— ë°© ì°¸ê°€í•˜ê¸°</h3>
                <p>ì¹œêµ¬ê°€ ê³µìœ í•œ ë°© ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”</p>
                <input type="text" id="roomCode" placeholder="ë°© ì½”ë“œ ì…ë ¥ (ì˜ˆ: ABC123)" maxlength="6">
                <button id="joinRoomBtn" class="btn-primary">ì°¸ê°€í•˜ê¸°</button>
            </div>

            <div class="stats-section">
                <h3>ğŸ“Š ë‚´ ì „ì </h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <span class="stat-label">ì´ ê²Œì„</span>
                        <span class="stat-value" id="totalGames">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">ìŠ¹ë¦¬</span>
                        <span class="stat-value" id="wins">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">ìŠ¹ë¥ </span>
                        <span class="stat-value" id="winRate">0%</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="waiting-room hidden" id="waitingRoom">
            <h2>ëŒ€ê¸°ì‹¤</h2>
            <div class="room-info">
                <p>ë°© ì½”ë“œ: <span id="currentRoomCode" class="room-code"></span></p>
                <button id="copyCodeBtn" class="btn-secondary">ì½”ë“œ ë³µì‚¬</button>
            </div>
            <div class="players-list">
                <div class="player-slot">
                    <span class="player-icon">ğŸ‘¤</span>
                    <span id="player1Name">ëŒ€ê¸° ì¤‘...</span>
                </div>
                <div class="vs-text">VS</div>
                <div class="player-slot">
                    <span class="player-icon">ğŸ‘¤</span>
                    <span id="player2Name">ëŒ€ê¸° ì¤‘...</span>
                </div>
            </div>
            <p class="waiting-text">ì¹œêµ¬ê°€ ì°¸ê°€í•  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...</p>
            <button id="cancelRoomBtn" class="btn-danger">ì·¨ì†Œ</button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <script src="js/firebase-config.js"></script>
    <script>
        // ì „ì—­ ë³€ìˆ˜
        let playerName = '';
        let currentRoomCode = '';
        let playerStats = { totalGames: 0, wins: 0 };

        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ í†µê³„ ë¶ˆëŸ¬ì˜¤ê¸°
        function loadStats() {
            const saved = localStorage.getItem('tetrisStats');
            if (saved) {
                playerStats = JSON.parse(saved);
                updateStatsDisplay();
            }
        }

        // í†µê³„ í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateStatsDisplay() {
            document.getElementById('totalGames').textContent = playerStats.totalGames;
            document.getElementById('wins').textContent = playerStats.wins;
            const winRate = playerStats.totalGames > 0 
                ? Math.round((playerStats.wins / playerStats.totalGames) * 100) 
                : 0;
            document.getElementById('winRate').textContent = winRate + '%';
        }

        // ì´ë¦„ ì„¤ì •
        document.getElementById('setNameBtn').addEventListener('click', () => {
            const name = document.getElementById('playerName').value.trim();
            if (name && name.length >= 2) {
                playerName = name;
                localStorage.setItem('playerName', name);
                document.getElementById('welcomeName').textContent = name;
                document.getElementById('loginContainer').classList.add('hidden');
                document.getElementById('menuContainer').classList.remove('hidden');
                loadStats();
            } else {
                alert('ì´ë¦„ì€ ìµœì†Œ 2ê¸€ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”!');
            }
        });

        // ë°© ë§Œë“¤ê¸°
        document.getElementById('createRoomBtn').addEventListener('click', async () => {
            currentRoomCode = generateRoomCode();
            
            try {
                await createRoom(currentRoomCode, playerName);
                showWaitingRoom();
            } catch (error) {
                console.error('ë°© ìƒì„± ì˜¤ë¥˜:', error);
                alert('ë°© ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            }
        });

        // ë°© ì°¸ê°€í•˜ê¸°
        document.getElementById('joinRoomBtn').addEventListener('click', async () => {
            const roomCode = document.getElementById('roomCode').value.trim().toUpperCase();
            
            if (roomCode.length !== 6) {
                alert('ì˜¬ë°”ë¥¸ ë°© ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”! (6ìë¦¬)');
                return;
            }

            try {
                const success = await joinRoom(roomCode, playerName);
                if (success) {
                    currentRoomCode = roomCode;
                    // ê²Œì„ ì‹œì‘
                    startGame(roomCode, playerName, false);
                } else {
                    alert('ë°©ì„ ì°¾ì„ ìˆ˜ ì—†ê±°ë‚˜ ì´ë¯¸ ê²Œì„ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('ë°© ì°¸ê°€ ì˜¤ë¥˜:', error);
                alert('ë°© ì°¸ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            }
        });

        // ë°© ì·¨ì†Œ
        document.getElementById('cancelRoomBtn').addEventListener('click', async () => {
            if (currentRoomCode) {
                await cancelRoom(currentRoomCode);
                hideWaitingRoom();
            }
        });

        // ì½”ë“œ ë³µì‚¬
        document.getElementById('copyCodeBtn').addEventListener('click', () => {
            navigator.clipboard.writeText(currentRoomCode).then(() => {
                alert('ë°© ì½”ë“œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
            });
        });

        // ëŒ€ê¸°ì‹¤ í‘œì‹œ
        function showWaitingRoom() {
            document.getElementById('menuContainer').classList.add('hidden');
            document.getElementById('waitingRoom').classList.remove('hidden');
            document.getElementById('currentRoomCode').textContent = currentRoomCode;
            document.getElementById('player1Name').textContent = playerName;
            document.getElementById('player2Name').textContent = 'ëŒ€ê¸° ì¤‘...';
        }

        // ëŒ€ê¸°ì‹¤ ìˆ¨ê¸°ê¸°
        function hideWaitingRoom() {
            document.getElementById('waitingRoom').classList.add('hidden');
            document.getElementById('menuContainer').classList.remove('hidden');
            currentRoomCode = '';
        }

        // ë°© ì½”ë“œ ìƒì„± (6ìë¦¬ ì˜ë¬¸+ìˆ«ì)
        function generateRoomCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        // ê²Œì„ ì‹œì‘
        function startGame(roomCode, playerName, isHost) {
            localStorage.setItem('gameRoom', roomCode);
            localStorage.setItem('playerName', playerName);
            localStorage.setItem('isHost', isHost);
            window.location.href = 'game.html';
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì €ì¥ëœ ì´ë¦„ ë¶ˆëŸ¬ì˜¤ê¸°
        window.addEventListener('load', () => {
            const savedName = localStorage.getItem('playerName');
            if (savedName) {
                document.getElementById('playerName').value = savedName;
            }
        });
    </script>
</body>
</html>
